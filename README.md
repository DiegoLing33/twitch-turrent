# Как оно работает

## 1. Настраивается конфигурация

```JSON
{
  "token": "rs455l40G6Zn1gfRWTj1",
  "rules": {
    "usd": [
      {
        "from": 0.1,
        "to": 0.2,
        "execute": "node /Users/me/script3.js",
        "enabled": false
      }
    ],
    "rub": [
      {
        "from": 1000,
        "to": 1000,
        "execute": "python3 /Users/me/script1.py",
        "enabled": true
      },
      {
        "from": 2000,
        "to": 2500,
        "execute": "python3 /Users/me/script2.py",
        "enabled": true
      }
    ]
  }
}
```

- `token` - токен Donation Alerts для виджетов. Находится в настройках профиля
- `rules` - правила работы программы. Выгдят как связка ключ-значение, где ключ - это валюта **в нижнем регистре**, значение - это список правил работы программы
  - `from` (число) - значение суммы от
  - `to` (число) - значение суммы до
  - `execute` - команда, которая должна будет выполниться на устройстве, например, запуск python скрипта
  - `enabled` (true/false) - флаг активации правила. Например, если какое-то правило больше не нужно, но будет нужно потом, достаточно написать `"enabled": false`.

## 2. Алгоритм работы программы

1. Программа подключается к **сокет-серверу Donation Alerts** и ожидает поступление пожертвований
2. Программа получает пожертвование, проверяет правила в конфигурации (`rules`) и если сумма пожертвования соответствует хотя бы одному критерию, помечает его статусом `PENDING` (ожидание) и кладет в файл `db.sqlite` (базу данных программы)
3. Если в момент получения пожертвования **не выполняются другие инструкции** (нет пожертвование в стутсе `IN_PROGRESS` (выполняется)), программа помечает пожертвование в статус `IN_PROGRESS` (выполняется) и переходит к пункту 4

- Если на момент получения пожертвования, уже есть пожертвование в статусе `IN_PROGRESS`, программа ничего не делает

4. Программа начинает выполнять инструкцию (`execute`) в сооствествии с конфигурацией по сумм пожертвования (`rules`)
5. Программа переходит к следующему пожертвованию в очереди

## 3. Отказоусточивость и исправления ошибок

1. Пожертвования, которые соотвествуют критериям `rules` из конфигурации, при получении, хранятся в базе данных, что гарантирует невозможность их потери

2. Если в работе программы возникли какие-то ошибки, они будут транслироваться в консоль и окрашены в красный цвет. Перезапуск программы не вызывает утерю уже существующих пожертвований, если какое-то пожертвование уже стало `IN_ROGRESS` (выполняется), при перезапуке программа вернет все пожертвования в статус `PENDING` (ожидание) и будет обрабатывать очередь еще раз

3. Если по какой-то причине очередь обработки остановилась. Существует способ запустить очередь "вручную". Для этого необходимо перейти по адресу: `http://IP_МАЛИНЫ_ВНУРИ_СЕТИ:3000/api/` и активировать "ручку" `/queue/next` (Запуск обработки очереди)

4. Если во время выполнения инструкции (`execute`) пожертвования возникнет ошибка, программа сообщит об этом в консоль и перестанет обрабатывать очередь, но **все еще будет сохранять входящие пожертвования**. Ошибка будет также описана в консоли, необходимо устранить ее и **после устранения ошибки** проследовать шагам:

- Перейти по адресу: `http://IP_МАЛИНЫ_ВНУРИ_СЕТИ:3000/api/`
- Активировать "ручку" `/donations/cancel-processing` (Сбрасывает пожертвования в процессинге в статус ожидания)
- Активировать "ручку" `/queue/next` (Запуск обработки очереди)

5. Пожертвования, который получены, пока программа выключена будут утеряны, однако есть способ добавить их "вручную", для этого необходимо проследовать шагам:

- Перейти по адресу: `http://IP_МАЛИНЫ_ВНУРИ_СЕТИ:3000/api/`
- Активировать "ручку" `/donations/create` (создает пожертвование)
- Активировать "ручку" `/queue/next` (Запуск обработки очереди)

ВНИМАНИЕ! Пожертвование, созданное вручную не вызывает активацию очереди, поэтому активировать ее необходио вручную (см. выше)

## 4. Мониторинг

Существует инструмент мониторинга работы программы:
`http://IP_МАЛИНЫ_ВНУРИ_СЕТИ:3000/frame.html?update_seconds=10&font_size=20`

Эту ссылку можно добавить в OBS, а также можно отслеживать ход выполнения пожертвований и главное - их очередь. В ссылке можно увидеть 2 параметра:
- update_seconds - обновление `экрана в секундах`. Конфигурируется под нагрузку на устройство, на которм выполняется программа. Минимально рекомендуемое значение - 5
- font_size - размер шрифта. По-умолчанию: 20
