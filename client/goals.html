<!doctype html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="style.css" />
    <title>Twitch Turret - Сборы средств</title>
  </head>
  <body>
    <div class="container">
      <h1>Сборы средств</h1>

      <!-- Управление очередью -->
      <div class="section">
        <h2>Управление очередью</h2>
        <div class="queue-controls">
          <div class="queue-controls-group">
            <button class="btn btn-start" onclick="startQueue()">Запустить очередь</button>
            <button class="btn btn-stop" onclick="stopQueue()">Остановить очередь</button>
          </div>
          <div class="queue-controls-group">
            <a href="monitor.html">
              <button class="btn">Мониторинг</button>
            </a>
            <a href="admin.html">
              <button class="btn">Пожертвования</button>
            </a>
            <a href="goals.html">
              <button class="btn">Сборы средств</button>
            </a>
          </div>
        </div>
      </div>

      <!-- Конфигурация сборов -->
      <div class="section">
        <h2>Конфигурация сборов</h2>
        <div class="button-group" style="margin-bottom: 20px">
          <button class="btn btn-secondary" onclick="loadConfigGoals()">Обновить конфигурацию</button>
          <button class="btn btn-primary" onclick="saveConfigGoals()">Сохранить конфигурацию</button>
          <button class="btn btn-primary" onclick="addConfigGoalsRow()">Добавить правило</button>
        </div>
        <div id="config-goals-container">
          <div class="loading">Загрузка конфигурации...</div>
        </div>
      </div>

      <!-- Счетчики сборов средств -->
      <div class="section">
        <h2>Счетчики сборов средств</h2>
        <div class="button-group" style="margin-bottom: 20px">
          <button class="btn btn-secondary" onclick="loadCountersData()">Обновить данные</button>
          <button class="btn btn-stop" onclick="clearCounters()">Очистить</button>
        </div>
        <div class="queue-grid">
          <div class="queue-table status-pending">
            <h3>Сборы средств</h3>
            <table>
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Сбор</th>
                  <th>Собрано</th>
                  <th>Цель</th>
                  <th>Итератор</th>
                </tr>
              </thead>
              <tbody id="counters-table">
                <tr><td colspan="5" class="loading">Загрузка...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Очередь задач сборов средств -->
      <div class="section">
        <h2>Очередь задач сборов средств</h2>
        <div class="button-group" style="margin-bottom: 20px">
          <button class="btn btn-secondary" onclick="loadQueueData()">Обновить данные</button>
        </div>
        <div class="queue-grid">
          <div class="queue-table status-pending">
            <h3>Ожидают (PENDING)</h3>
            <table>
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Название</th>
                  <th>Сумма</th>
                </tr>
              </thead>
              <tbody id="pending-queue">
                <tr><td colspan="3" class="loading">Загрузка...</td></tr>
              </tbody>
            </table>
          </div>

          <div class="queue-table status-progress">
            <h3>В обработке (IN_PROGRESS)</h3>
            <table>
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Название</th>
                  <th>Сумма</th>
                </tr>
              </thead>
              <tbody id="progress-queue">
                <tr><td colspan="3" class="loading">Загрузка...</td></tr>
              </tbody>
            </table>
          </div>

          <div class="queue-table status-completed">
            <h3>Завершены (COMPLETED)</h3>
            <table>
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Название</th>
                  <th>Сумма</th>
                </tr>
              </thead>
              <tbody id="completed-queue">
                <tr><td colspan="3" class="loading">Загрузка...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Ручное создание пожертвования -->
      <div class="section">
        <h2>Отправить пожертвование вручную</h2>
        <div class="form-row">
          <div class="form-group">
            <label for="manual-title">Название сбора средств:</label>
            <input type="text" id="manual-title" placeholder="Введите название сбора средств" />
          </div>
          <div class="form-group">
            <label for="manual-goal-amount">Цель:</label>
            <input type="number" id="manual-goal-amount" step="0.01" placeholder="Введите сумму" />
          </div>
          <div class="form-group">
            <label for="manual-raised-amount">Собрано:</label>
            <input type="number" id="manual-raised-amount" step="0.01" placeholder="Введите сумму" />
          </div>
          <div class="form-group">
            <label for="manual-currency">Валюта:</label>
            <select id="manual-currency">
              <option value="rub">RUB</option>
              <option value="usd">USD</option>
            </select>
          </div>
        </div>
        <button class="btn btn-primary" onclick="createManualDonation()">Отправить пожертвование</button>
      </div>
    </div>

    <script>
      let configGoalsData = []

      // Функции управления очередью
      async function startQueue() {
        try {
          const response = await fetch('/queue/next', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
          })

          if (response.ok) {
            showMessage('Очередь запущена!', 'success')
            loadQueueData()
          } else {
            showMessage('Ошибка при запуске очереди', 'error')
          }
        } catch (error) {
          showMessage('Ошибка сети: ' + error.message, 'error')
        }
      }

      async function stopQueue() {
        try {
          const response = await fetch('/donations/cancel-processing', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
          })
          const response2 = await fetch('/goals/cancel-processing', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
          })

          if (response.ok && response2.ok) {
            showMessage('Очередь остановлена!', 'success')
            loadQueueData()
          } else {
            showMessage('Ошибка при остановке очереди', 'error')
          }
        } catch (error) {
          showMessage('Ошибка сети: ' + error.message, 'error')
        }
      }

      async function clearCounters() {
        const container = document.getElementById('counters-table')
        try {
          const response = await fetch(`/goals/delete-all`, { method: 'POST' })
          if (response.ok) {
            await loadCountersData()
          }
        } catch (error) {
          showMessage('Ошибка сети: ' + error.message, 'error')
        }
      }

      async function loadCountersData() {
        const container = document.getElementById('counters-table')
        try {
          const response = await fetch(`/goals/last`)
          if (response.ok) {
            const data = await response.json()
            renderCountersTable(container, data)
          } else {
            container.innerHTML = '<tr><td colspan="5" class="error">Ошибка загрузки</td></tr>'
          }
        } catch (error) {
          container.innerHTML = '<tr><td colspan="5" class="error">Ошибка сети</td></tr>'
        }
      }

      // Загрузка данных очереди
      async function loadQueueData() {
        const statuses = ['PENDING', 'IN_PROGRESS', 'COMPLETED']
        const containers = ['pending-queue', 'progress-queue', 'completed-queue']

        for (let i = 0; i < statuses.length; i++) {
          const status = statuses[i]
          const container = document.getElementById(containers[i])

          try {
            const response = await fetch(`/goals/tasks/last?status=${status}`)

            if (response.ok) {
              const data = await response.json()
              renderQueueTable(container, data)
            } else {
              container.innerHTML = '<tr><td colspan="3" class="error">Ошибка загрузки</td></tr>'
            }
          } catch (error) {
            container.innerHTML = '<tr><td colspan="3" class="error">Ошибка сети</td></tr>'
          }
        }
      }

      function renderCountersTable(container, data) {
        if (data.length === 0) {
          container.innerHTML = '<tr><td colspan="5">Нет данных</td></tr>'
          return
        }

        const rows = data
          .map(
            item => `
                <tr>
                    <td>${item.id.substring(0, 8)}</td>
                    <td>${item.title}</td>
                    <td>${item.raisedAmount} ${item.currency.toUpperCase()}</td>
                    <td>${item.goalAmount} ${item.currency.toUpperCase()}</td>
                    <td>${item.iterator}</td>
                </tr>
            `,
          )
          .join('')

        container.innerHTML = rows
      }

      function renderQueueTable(container, data) {
        if (data.length === 0) {
          container.innerHTML = '<tr><td colspan="3">Нет данных</td></tr>'
          return
        }

        const rows = data
          .map(
            item => `
                <tr>
                    <td>${item.id.substring(0, 8)}</td>
                    <td>${item.title}</td>
                    <td>${item.raisedAmount} ${item.currency.toUpperCase()}</td>
                </tr>
            `,
          )
          .join('')

        container.innerHTML = rows
      }

      // Загрузка конфигурации
      async function loadConfigGoals() {
        try {
          const response = await fetch('/dynamic-data/goals-config')

          if (response.ok) {
            configGoalsData = await response.json()
            renderGoalsConfigTable()
          } else {
            showMessage('Ошибка загрузки конфигурации', 'error')
          }
        } catch (error) {
          showMessage('Ошибка сети: ' + error.message, 'error')
        }
      }

      function renderGoalsConfigTable() {
        const container = document.getElementById('config-goals-container')

        if (configGoalsData.length === 0) {
          container.innerHTML = '<div>Нет правил конфигурации</div>'
          return
        }

        const tableHTML = `
                <table class="config-table">
                    <thead>
                        <tr>
                            <th>Название</th>
                            <th>Команда</th>
                            <th>Включено</th>
                            <th>Действия</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${configGoalsData
                          .map(
                            (item, index) => `
                            <tr>
                                <td><input type="text" step="0.01" value="${item.name}" onchange="updateConfigValue(${index}, 'name', this.value)"></td>
                                <td><input type="text" value="${item.execute}" onchange="updateConfigValue(${index}, 'execute', this.value)"></td>
                                <td>
                                    <div class="checkbox-wrapper">
                                        <input type="checkbox" ${item.enabled ? 'checked' : ''} onchange="updateConfigValue(${index}, 'enabled', this.checked)">
                                    </div>
                                </td>
                                <td>
                                    <button class="btn btn-stop" onclick="removeConfigRow(${index})" style="padding: 6px 12px; font-size: 14px;">Удалить</button>
                                </td>
                            </tr>
                        `,
                          )
                          .join('')}
                    </tbody>
                </table>
            `

        container.innerHTML = tableHTML
      }

      function updateConfigValue(index, field, value) {
        if (field === 'from' || field === 'to') {
          configGoalsData[index][field] = parseFloat(value) || 0
        } else if (field === 'enabled') {
          configGoalsData[index][field] = value
        } else {
          configGoalsData[index][field] = value
        }
      }

      function addConfigGoalsRow() {
        configGoalsData.push({
          name: '',
          execute: '',
          enabled: true,
        })
        renderGoalsConfigTable()
      }

      function removeConfigGoalsRow(index) {
        configGoalsData.splice(index, 1)
        renderGoalsConfigTable()
      }

      async function saveConfigGoals() {
        const saveButton = document.querySelector('button[onclick="saveConfigGoals()"]')
        const originalText = saveButton.textContent

        // Устанавливаем состояние загрузки
        saveButton.textContent = 'Сохранение...'
        saveButton.disabled = true
        saveButton.style.opacity = '0.7'
        saveButton.style.cursor = 'not-allowed'

        try {
          const response = await fetch('/dynamic-data/goals-config', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(configGoalsData),
          })

          if (response.ok) {
            // Показываем успех
            saveButton.textContent = '✓ Сохранено!'
            saveButton.style.background = 'linear-gradient(45deg, #10b981, #059669)'
            showMessage('Конфигурация сохранена!', 'success')

            // Возвращаем исходное состояние через 2 секунды
            setTimeout(() => {
              saveButton.textContent = originalText
              saveButton.style.background = 'linear-gradient(45deg, #9d4edd, #7b2cbf)'
              saveButton.disabled = false
              saveButton.style.opacity = '1'
              saveButton.style.cursor = 'pointer'
            }, 2000)
          } else {
            showMessage('Ошибка при сохранении конфигурации', 'error')
            // Возвращаем исходное состояние при ошибке
            saveButton.textContent = originalText
            saveButton.disabled = false
            saveButton.style.opacity = '1'
            saveButton.style.cursor = 'pointer'
          }
        } catch (error) {
          showMessage('Ошибка сети: ' + error.message, 'error')
          // Возвращаем исходное состояние при ошибке
          saveButton.textContent = originalText
          saveButton.disabled = false
          saveButton.style.opacity = '1'
          saveButton.style.cursor = 'pointer'
        }
      }

      // Создание пожертвования вручную
      async function createManualDonation() {
        const title = document.getElementById('manual-title').value
        const raised = parseFloat(document.getElementById('manual-raised-amount').value)
        const goal = parseFloat(document.getElementById('manual-goal-amount').value)
        const currency = document.getElementById('manual-currency').value

        if (!title || !raised || !goal || !currency) {
          showMessage('Заполните обязательные поля: название, собранная сумма, цель и валюта', 'error')
          return
        }

        try {
          const response = await fetch('/goals/create', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              title,
              raised,
              goal,
              currency,
            }),
          })

          if (response.ok) {
            showMessage('Пожертвование в сбор средств создано!', 'success')
            // Очистка формы
            document.getElementById('manual-title').value = ''
            document.getElementById('manual-raised-amount').value = ''
            document.getElementById('manual-goal-amount').value = ''
            loadQueueData()
          } else {
            showMessage('Ошибка при создании пожертвования', 'error')
          }
        } catch (error) {
          showMessage('Ошибка сети: ' + error.message, 'error')
        }
      }

      // Вспомогательные функции
      function showMessage(text, type) {
        // Удаляем предыдущие сообщения
        const existingMessages = document.querySelectorAll('.error, .success')
        existingMessages.forEach(msg => msg.remove())

        const messageDiv = document.createElement('div')
        messageDiv.className = type
        messageDiv.textContent = text

        document.querySelector('.container').insertBefore(messageDiv, document.querySelector('.section'))

        // Автоматически убираем сообщение через 5 секунд
        setTimeout(() => {
          messageDiv.remove()
        }, 5000)
      }

      // Загрузка данных при загрузке страницы
      document.addEventListener('DOMContentLoaded', function () {
        loadQueueData()
        loadCountersData()
        loadConfigGoals()
      })

      // Автообновление данных очереди каждые 30 секунд
      setInterval(loadQueueData, 30000)
      setInterval(loadCountersData, 40000)
    </script>
  </body>
</html>
